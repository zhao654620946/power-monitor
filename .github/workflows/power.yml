name: power-monitor

permissions:
  contents: write
  issues: write

on:
  schedule:
    - cron: "0 * * * *"   # 每小时执行
  workflow_dispatch:

jobs:
  fetch-power:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip jq bc
          pip3 install pandas matplotlib

      - name: Fetch power data and alert if low
        env:
          POWER_URL: ${{ secrets.POWER_URL }}
          POWER_RID: ${{ secrets.POWER_RID }}
          POWER_TOKEN: ${{ secrets.POWER_TOKEN }}
          TZ: Asia/Shanghai
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          RESPONSE=$(curl -s -X POST "$POWER_URL" \
            -H 'content-type: application/x-www-form-urlencoded;charset=UTF-8' \
            --data "rid=${POWER_RID}&token=${POWER_TOKEN}")

          VALUE=$(echo "$RESPONSE" | jq -r '.data[0].oddelec')

          if [ "$VALUE" = "null" ] || [ -z "$VALUE" ]; then
            echo "Failed to parse power value"
            exit 0
          fi

          TIME=$(date '+%F %T')
          echo "$TIME $VALUE" >> power.txt

          # ===== 低电量提醒 =====
          THRESHOLD=20
          LOW=$(echo "$VALUE < $THRESHOLD" | bc)

          if [ "$LOW" -eq 1 ]; then
            TODAY=$(date '+%F')
            TITLE="$TODAY 电费不足提醒"

            EXIST=$(gh issue list \
              --search "$TITLE" \
              --state open \
              --json title \
              --jq 'length')

            if [ "$EXIST" -eq 0 ]; then
              gh issue create \
                --title "$TITLE" \
                --body "⚠️ **宿舍电费不足提醒**\n\n当前电费：**${VALUE} 度**\n阈值：**${THRESHOLD} 度**\n记录时间：${TIME}\n\n请尽快充值。"
            fi
          fi

      - name: Generate charts and update README
        run: |
          python3 << 'EOF'
          import pandas as pd
          import matplotlib.pyplot as plt
          from pathlib import Path

          # ===== 读取数据 =====
          df = pd.read_csv(
              "power.txt",
              sep=" ",
              names=["date", "time", "power"],
              parse_dates=[["date", "time"]]
          )

          df = df.sort_values("date_time")
          df.set_index("date_time", inplace=True)
          df["power"] = df["power"].astype(float)

          # ===== 画图函数 =====
          def plot(data, title, filename):
              plt.figure(figsize=(10, 5))
              plt.plot(data.index, data["power"])
              plt.title(title)
              plt.xlabel("Time")
              plt.ylabel("Remaining Power")
              plt.grid(True)
              plt.tight_layout()
              plt.savefig(filename)
              plt.close()

          plot(df, "Total Power Trend", "power_all.png")
          plot(df.last("30D"), "Power Trend - Last 30 Days", "power_30d.png")
          plot(df.last("7D"), "Power Trend - Last 7 Days", "power_7d.png")
          plot(df.last("24H"), "Power Trend - Last 24 Hours", "power_24h.png")

          # ===== 每天用电量 =====
          df["usage"] = -df["power"].diff()
          daily = df["usage"].resample("D").sum()
          daily = daily[daily > 0].tail(30)

          # 保存 CSV
          daily.to_csv("daily_usage.csv", header=["daily_usage"])

          # ===== 生成 Markdown 表格 =====
          md = []
          md.append("| 日期 | 用电量 (度) |")
          md.append("|------|-------------|")

          for date, val in daily.items():
              md.append(f"| {date.date()} | {val:.2f} |")

          table_md = "\n".join(md)

          # ===== 更新 README =====
          readme = Path("README.md")
          content = readme.read_text(encoding="utf-8")

          start = "<!-- DAILY_POWER_TABLE_START -->"
          end = "<!-- DAILY_POWER_TABLE_END -->"

          new_content = (
              content.split(start)[0]
              + start
              + "\n\n"
              + table_md
              + "\n\n"
              + end
              + content.split(end)[1]
          )

          readme.write_text(new_content, encoding="utf-8")
          EOF

      - name: Commit and push updates
        run: |
          git config user.name "power-bot"
          git config user.email "power-bot@users.noreply.github.com"

          git add power.txt *.png daily_usage.csv README.md
          git diff --cached --quiet || git commit -m "update power data, charts and daily usage table"
          git push
