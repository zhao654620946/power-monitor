name: power-monitor

permissions:
  contents: write
  issues: write

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  fetch-power:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install matplotlib pandas

      - name: Fetch power data and alert if low
        env:
          POWER_URL: ${{ secrets.POWER_URL }}
          POWER_RID: ${{ secrets.POWER_RID }}
          POWER_TOKEN: ${{ secrets.POWER_TOKEN }}
          TZ: Asia/Shanghai
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          RESPONSE=$(curl -s -X POST "$POWER_URL" \
            -H 'content-type: application/x-www-form-urlencoded;charset=UTF-8' \
            --data "rid=${POWER_RID}&token=${POWER_TOKEN}")

          VALUE=$(echo "$RESPONSE" | jq -r '.data[0].oddelec')

          if [ "$VALUE" = "null" ] || [ -z "$VALUE" ]; then
            echo "Failed to parse power value"
            exit 0
          fi

          TIME=$(date '+%F %T')
          echo "$TIME $VALUE" >> power.txt

          # ===== 低电量提醒 =====
          THRESHOLD=20
          LOW=$(echo "$VALUE < $THRESHOLD" | bc)

          if [ "$LOW" -eq 1 ]; then
            TODAY=$(date '+%F')
            TITLE="$TODAY 电费不足提醒"

            EXIST=$(gh issue list \
              --search "$TITLE" \
              --state open \
              --json title \
              --jq 'length')

            if [ "$EXIST" -eq 0 ]; then
              gh issue create \
                 --title "$TITLE" \
                 --body "⚠️ **宿舍电费不足提醒**\n\n当前电费：**${VALUE} 度**\n阈值：**${THRESHOLD} 度**\n记录时间：${TIME}\n\n请尽快充值。"
            fi
          fi

      - name: Generate power trend chart
        run: |
          python3 << 'EOF'
          import pandas as pd
          import matplotlib.pyplot as plt

          df = pd.read_csv(
              "power.txt",
              sep=" ",
              names=["date", "time", "power"],
              parse_dates=[["date", "time"]]
          )

          plt.figure(figsize=(10, 5))
          plt.plot(df["date_time"], df["power"], marker="o")
          plt.xlabel("Time")
          plt.ylabel("Remaining Power")
          plt.title("Dormitory Power Trend")
          plt.xticks(rotation=45)
          plt.tight_layout()
          plt.grid(True)

          plt.savefig("power.png")
          EOF

      - name: Commit and push data & chart
        run: |
          git config user.name "power-bot"
          git config user.email "power-bot@users.noreply.github.com"

          git add power.txt power.png
          git diff --cached --quiet || git commit -m "update power data and chart"
          git push
